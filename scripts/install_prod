# Prod install script for Tournament Organiser.
#
# This will make sure the prod settings are configured properly
#
# To do a prod install you need to run this file on prod
#
# This will run all the tests that don't affect the db
#
# What you need:
#       - CHECK there is a file at config/prod/docker-compose.prod.yml It should
#       contain all the environment variables specific to prod (like passwords)
#       THIS WILL NOT BE CHECKED IN!!! You should scp it from your home machine.
#
# Using the existing db:
#       - If you would like to use the existing db info you just need to make
#       sure the prod compose file includes a "volumes_from" pointing at dbstore


#! /bin/bash

# Check if there is an available db store. If not then we make one for
# persistent volumes.
EXISTING_DB_STORE=$(docker ps -a | grep "dbstore$" | awk '{print $1}')
if [[ -z "$EXISTING_DB_STORE" ]]
then
    docker create -v /dbdata --name dbstore postgres:9.3 bin/true
fi


./scripts/install config/production/docker-compose.prod.yml


# Non-destructive tests
docker-compose run daoserver python -m unittest discover -s unit_tests \
    --pattern=*.py
